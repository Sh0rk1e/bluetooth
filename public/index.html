<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Bluetooth Controller</title>
    <style>
        :root {
            --bg-primary: white;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #edf2f7;
            --text-primary: #4a5568;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --header-bg: #4a5568;
            --status-bg: #2d3748;
            --console-bg: #1a202c;
            --console-text: #a0aec0;
        }

        .dark-mode {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --header-bg: #2d3748;
            --status-bg: #1a202c;
            --console-bg: #0f1419;
            --console-text: #cbd5e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-primary);
            background-color: var(--bg-primary);
        }

        .container {
            background: var(--bg-primary);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            width: 100%;
            max-width: 1100px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        .header {
            background: var(--header-bg);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-bar {
            background: var(--status-bg);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e53e3e;
        }

        .status-dot.connected {
            background: #38a169;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .left-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .controls-section {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .controls-header h3 {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding-right: 10px;
            flex: 1;
        }

        .control-btn {
            background: var(--bg-tertiary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 20px 10px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            user-select: none;
            position: relative;
            min-height: 120px;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .control-btn:active {
            transform: translateY(-1px);
        }

        .control-btn i {
            font-size: 1.8em;
        }

        .control-btn .btn-label {
            font-weight: 600;
            font-size: 1em;
            text-align: center;
        }

        .control-btn .btn-command {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            font-family: monospace;
        }

        .btn-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7em;
            display: none;
        }

        .control-btn:hover .btn-remove {
            display: block;
        }

        .btn-remove:hover {
            background: rgba(255, 0, 0, 0.9);
        }

        .add-btn-container {
            text-align: center;
            margin-top: 15px;
            flex-shrink: 0;
        }

        .add-btn {
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 0.9em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .add-btn:hover {
            background: #3182ce;
        }

        .right-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: var(--border-color);
        }

        .tab.active {
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #4299e1;
        }

        .tab-content {
            flex: 1;
            overflow: hidden;
            display: none;
            background: var(--bg-primary);
            transition: background-color 0.3s ease;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .tab-pane {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Console Tab Styles */
        .console {
            background: var(--console-bg);
            color: var(--console-text);
            border-radius: 10px;
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin: 10px;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .console-header {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .console-controls {
            display: flex;
            gap: 8px;
        }

        .console-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--console-text);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .console-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .console-output {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .console-line {
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-color);
            line-height: 1.4;
            transition: border-color 0.3s ease;
        }

        .console-line:last-child {
            border-bottom: none;
        }

        /* Code Tab Styles */
        .code-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 10px;
        }

        .code-header {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .code-select {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .code-display {
            flex: 1;
            overflow-y: auto;
            background: var(--console-bg);
            color: var(--console-text);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
            white-space: pre-wrap;
            tab-size: 4;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .code-comment {
            color: var(--text-secondary);
        }

        .code-keyword {
            color: #4299e1;
            font-weight: bold;
        }

        .code-string {
            color: #68d391;
        }

        .code-function {
            color: #d69e2e;
        }

        .code-number {
            color: #f68787;
        }

        /* Settings Tab Styles */
        .settings-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-group {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .settings-group h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .settings-group h3 i {
            color: #4299e1;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-label {
            color: var(--text-primary);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4299e1;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .range {
            width: 150px;
            height: 5px;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            transition: background-color 0.3s ease;
        }

        .range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4299e1;
            cursor: pointer;
        }

        .range-value {
            min-width: 30px;
            text-align: center;
            font-family: monospace;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        /* Joystick Tab Styles */
        .joystick-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
        }

        .joystick-header {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .joystick-control-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .joystick-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .joystick-area {
            width: 300px;
            height: 300px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            position: relative;
            touch-action: none;
            user-select: none;
        }

        .axis-indicators {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            pointer-events: none;
        }

        .axis-line {
            position: absolute;
            background: var(--border-color);
        }

        .axis-line.horizontal {
            width: 100%;
            height: 2px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        .axis-line.vertical {
            width: 2px;
            height: 100%;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .direction-marker {
            position: absolute;
            color: var(--text-secondary);
            font-size: 1.2em;
            opacity: 0.5;
        }

        .direction-marker.up {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .direction-marker.down {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .direction-marker.left {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .direction-marker.right {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .joystick {
            position: absolute;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            border-radius: 50%;
            cursor: move;
            top: 110px;
            left: 110px;
            box-shadow: 0 5px 20px rgba(66, 153, 225, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            border: 3px solid white;
            z-index: 10;
        }

        .joystick:active {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.6);
        }

        .joystick-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 300px;
        }

        .joystick-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .joystick-btn:hover {
            background: var(--border-color);
        }

        .joystick-btn.active {
            background: #4299e1;
            color: white;
        }

        .joystick-btn .btn-text {
            margin-left: 5px;
        }

        .joystick-config {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 300px;
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-item label {
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .config-item input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .config-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4299e1;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .config-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #4299e1;
            text-align: center;
            font-family: monospace;
        }

        .joystick-display {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .joystick-data {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            width: 300px;
        }

        .data-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .data-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4299e1;
            font-family: monospace;
        }

        .data-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .motor-display {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .motor-diagram {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .motor-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .motor-wrapper {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .motor {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .motor.active {
            border-color: #4299e1;
            box-shadow: 0 5px 15px rgba(66, 153, 225, 0.2);
        }

        .motor-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .motor-speed {
            font-size: 2em;
            font-weight: bold;
            color: #4299e1;
            font-family: monospace;
            margin: 10px 0;
        }

        .motor-direction {
            font-size: 1em;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 20px;
            background: var(--bg-primary);
            display: inline-block;
        }

        .motor-direction.forward {
            color: #38a169;
            background: rgba(56, 161, 105, 0.1);
        }

        .motor-direction.backward {
            color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
        }

        .motor-direction.stop {
            color: #718096;
            background: rgba(113, 128, 150, 0.1);
        }

        /* Connection Info */
        .connection-info {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
            margin: 10px;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .connection-info h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-details {
            font-size: 0.85em;
            color: var(--text-secondary);
            line-height: 1.5;
            white-space: pre-line;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--text-primary);
            font-family: monospace;
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        .footer {
            text-align: center;
            padding: 15px;
            color: var(--text-secondary);
            font-size: 0.8em;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color 0.3s ease;
        }

        .modal-header {
            background: var(--header-bg);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: #4299e1;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }

        .icon-picker {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            font-size: 1.2em;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .icon-option:hover {
            background: var(--border-color);
            transform: scale(1.1);
        }

        .icon-option.selected {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                height: 95vh;
                max-width: 95vw;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .right-panel {
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
            
            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .joystick-area {
                width: 250px;
                height: 250px;
            }
            
            .joystick {
                width: 60px;
                height: 60px;
                top: 95px;
                left: 95px;
            }
            
            .joystick-controls,
            .joystick-config,
            .joystick-data {
                width: 250px;
            }
            
            .joystick-config {
                grid-template-columns: 1fr;
            }
            
            .joystick-display {
                width: 250px;
            }
        }

        @media (max-width: 480px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .joystick-area {
                width: 200px;
                height: 200px;
            }
            
            .joystick {
                width: 50px;
                height: 50px;
                top: 75px;
                left: 75px;
            }
            
            .joystick-controls,
            .joystick-config,
            .joystick-data,
            .joystick-display {
                width: 200px;
            }
            
            .motor-wrapper {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> Arduino Bluetooth Controller</h1>
            <p>Control your Arduino via Bluetooth with custom buttons</p>
            <div class="header-controls">
                <button class="header-btn" id="helpBtn" title="Help">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button class="header-btn" id="settingsBtn" title="Settings">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="bluetoothStatus"></div>
                <span id="bluetoothText">Bluetooth: Disconnected</span>
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="websocketStatus"></div>
                <span id="websocketText">WebSocket: Disconnected</span>
            </div>
            <div class="status-indicator">
                <span id="buttonCount">0 buttons</span>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="controls-section">
                    <div class="controls-header">
                        <h3><i class="fas fa-gamepad"></i> Control Panel</h3>
                        <button class="add-btn" id="addButton">
                            <i class="fas fa-plus"></i> Add Button
                        </button>
                    </div>
                    <div class="controls-grid" id="buttonsGrid">
                        <!-- Buttons will be dynamically added here -->
                    </div>
                </div>
                
                <div class="connection-info">
                    <h3><i class="fas fa-info-circle"></i> Connection Status</h3>
                    <div class="connection-details" id="connectionDetails">
                        Connecting to server...
                    </div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="messagesSent">0</div>
                            <div class="stat-label">Sent</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="messagesReceived">0</div>
                            <div class="stat-label">Received</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="tabs">
                    <button class="tab active" data-tab="console">
                        <i class="fas fa-terminal"></i> Console
                    </button>
                    <button class="tab" data-tab="joystick">
                        <i class="fas fa-gamepad"></i> Joystick
                    </button>
                    <button class="tab" data-tab="code">
                        <i class="fas fa-code"></i> Code
                    </button>
                    <button class="tab" data-tab="settings">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>

                <div class="tab-content active" id="console-tab">
                    <div class="tab-pane">
                        <div class="console">
                            <div class="console-header">
                                Arduino Console
                                <div class="console-controls">
                                    <button class="console-btn" id="clearConsole">
                                        <i class="fas fa-trash"></i> Clear
                                    </button>
                                    <button class="console-btn" id="pauseConsole">
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                </div>
                            </div>
                            <div class="console-output" id="consoleOutput">
                                <!-- Console messages will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="joystick-tab">
                    <div class="tab-pane">
                        <div class="joystick-container">
                            <div class="joystick-header">
                                <i class="fas fa-gamepad"></i> Virtual Joystick Controller
                            </div>
                            
                            <div class="joystick-control-panel">
                                <div class="joystick-wrapper">
                                    <div class="joystick-area" id="joystickArea">
                                        <div class="axis-indicators">
                                            <div class="axis-line horizontal"></div>
                                            <div class="axis-line vertical"></div>
                                            <div class="direction-marker up" title="Forward">‚Üë</div>
                                            <div class="direction-marker down" title="Backward">‚Üì</div>
                                            <div class="direction-marker left" title="Left">‚Üê</div>
                                            <div class="direction-marker right" title="Right">‚Üí</div>
                                        </div>
                                        <div class="joystick" id="joystick">
                                            <i class="fas fa-arrows-alt"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="joystick-controls">
                                        <button class="joystick-btn" id="joystickMode" data-mode="analog">
                                            <i class="fas fa-sliders-h"></i> <span class="btn-text">Analog Mode</span>
                                        </button>
                                        <button class="joystick-btn" id="joystickCenter">
                                            <i class="fas fa-crosshairs"></i> <span class="btn-text">Center</span>
                                        </button>
                                    </div>
                                    
                                    <div class="joystick-config">
                                        <div class="config-item">
                                            <label for="sensitivity">Sensitivity:</label>
                                            <input type="range" id="sensitivity" min="1" max="10" value="5">
                                            <span class="config-value" id="sensitivityValue">5</span>
                                        </div>
                                        <div class="config-item">
                                            <label for="deadzone">Deadzone:</label>
                                            <input type="range" id="deadzone" min="0" max="30" value="10">
                                            <span class="config-value" id="deadzoneValue">10%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="joystick-display">
                                    <div class="joystick-data">
                                        <div class="data-item">
                                            <div class="data-value" id="joystickX">0.00</div>
                                            <div class="data-label">X Axis</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-value" id="joystickY">0.00</div>
                                            <div class="data-label">Y Axis</div>
                                        </div>
                                        <div class="data-item">
                                            <div class="data-value" id="joystickAngle">0¬∞</div>
                                            <div class="data-label">Angle</div>
                                        </div>
                                    </div>
                                    
                                    <div class="motor-display">
                                        <div class="motor-diagram">
                                            <div class="motor-title">H-Bridge Motor Control</div>
                                            <div class="motor-wrapper">
                                                <div class="motor left-motor">
                                                    <div class="motor-label">Left Motor</div>
                                                    <div class="motor-speed" id="leftMotorSpeed">0%</div>
                                                    <div class="motor-direction" id="leftMotorDir">STOP</div>
                                                </div>
                                                <div class="motor right-motor">
                                                    <div class="motor-label">Right Motor</div>
                                                    <div class="motor-speed" id="rightMotorSpeed">0%</div>
                                                    <div class="motor-direction" id="rightMotorDir">STOP</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="code-tab">
                    <div class="tab-pane">
                        <div class="code-container">
                            <div class="code-header">
                                Arduino Code Examples
                                <select class="code-select" id="codeSelect">
                                    <option value="joystick">H-Bridge Joystick Control</option>
                                    <option value="basic">Basic Serial Control</option>
                                    <option value="motor">DC Motor Control</option>
                                    <option value="servo">Servo Motor Control</option>
                                    <option value="led">LED Control</option>
                                    <option value="sensor">Sensor Reading</option>
                                </select>
                            </div>
                            <pre class="code-display" id="codeDisplay">
                                // Select a code example from the dropdown
                            </pre>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="settings-tab">
                    <div class="tab-pane">
                        <div class="settings-container">
                            <div class="settings-group">
                                <h3><i class="fas fa-wifi"></i> Connection Settings</h3>
                                <div class="setting-item">
                                    <div class="setting-label">Auto-reconnect</div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="autoReconnect" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">Reconnect delay (seconds)</div>
                                    <div class="setting-control">
                                        <input type="range" min="1" max="30" value="5" class="range" id="reconnectDelay">
                                        <span class="range-value" id="reconnectDelayValue">5</span>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">Show timestamps</div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="showTimestamps" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group">
                                <h3><i class="fas fa-palette"></i> Display Settings</h3>
                                <div class="setting-item">
                                    <div class="setting-label">Dark mode</div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="darkMode">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">Button animation</div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="buttonAnimation" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">Console font size</div>
                                    <div class="setting-control">
                                        <input type="range" min="10" max="20" value="14" class="range" id="consoleFontSize">
                                        <span class="range-value" id="consoleFontSizeValue">14</span>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group">
                                <h3><i class="fas fa-database"></i> Data Management</h3>
                                <div class="setting-item">
                                    <div class="setting-label">Auto-save buttons</div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="autoSaveButtons" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">Save console history</div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="saveConsoleHistory">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">Maximum console lines</div>
                                    <div class="setting-control">
                                        <input type="range" min="10" max="200" value="100" class="range" id="maxConsoleLines">
                                        <span class="range-value" id="maxConsoleLinesValue">100</span>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-group">
                                <h3><i class="fas fa-tools"></i> Tools</h3>
                                <div class="setting-item">
                                    <div class="setting-label">Export buttons configuration</div>
                                    <div class="setting-control">
                                        <button class="btn btn-secondary" id="exportButtons">
                                            <i class="fas fa-download"></i> Export
                                        </button>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">Import buttons configuration</div>
                                    <div class="setting-control">
                                        <button class="btn btn-secondary" id="importButtons">
                                            <i class="fas fa-upload"></i> Import
                                        </button>
                                        <input type="file" id="importFile" accept=".json" style="display: none;">
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">Reset to defaults</div>
                                    <div class="setting-control">
                                        <button class="btn btn-secondary" id="resetSettings">
                                            <i class="fas fa-redo"></i> Reset
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Arduino Bluetooth Bridge v2.0 | Press Ctrl+Shift+N to add new button</p>
        </div>
    </div>

    <!-- Button Configuration Modal -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Configure Button</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="buttonForm">
                    <input type="hidden" id="buttonId">
                    
                    <div class="form-group">
                        <label for="buttonName">Button Name</label>
                        <input type="text" id="buttonName" class="form-control" placeholder="e.g., Turn On LED" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="buttonCommand">Arduino Command</label>
                        <input type="text" id="buttonCommand" class="form-control" placeholder="e.g., L1, F, B, S" required>
                        <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                            Single character or short command to send to Arduino
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Button Color</label>
                        <div class="color-picker">
                            <div class="color-option" style="background: #38a169;" data-color="#38a169"></div>
                            <div class="color-option" style="background: #4299e1;" data-color="#4299e1"></div>
                            <div class="color-option" style="background: #e53e3e;" data-color="#e53e3e"></div>
                            <div class="color-option" style="background: #d69e2e;" data-color="#d69e2e"></div>
                            <div class="color-option" style="background: #805ad5;" data-color="#805ad5"></div>
                            <div class="color-option" style="background: #dd6b20;" data-color="#dd6b20"></div>
                            <div class="color-option" style="background: #4a5568;" data-color="#4a5568"></div>
                            <div class="color-option" style="background: #319795;" data-color="#319795"></div>
                        </div>
                        <input type="hidden" id="buttonColor" value="#4a5568">
                    </div>
                    
                    <div class="form-group">
                        <label>Button Icon</label>
                        <div class="icon-picker">
                            <div class="icon-option" data-icon="fas fa-play"><i class="fas fa-play"></i></div>
                            <div class="icon-option" data-icon="fas fa-stop"><i class="fas fa-stop"></i></div>
                            <div class="icon-option" data-icon="fas fa-arrow-up"><i class="fas fa-arrow-up"></i></div>
                            <div class="icon-option" data-icon="fas fa-arrow-down"><i class="fas fa-arrow-down"></i></div>
                            <div class="icon-option" data-icon="fas fa-arrow-left"><i class="fas fa-arrow-left"></i></div>
                            <div class="icon-option" data-icon="fas fa-arrow-right"><i class="fas fa-arrow-right"></i></div>
                            <div class="icon-option" data-icon="fas fa-power-off"><i class="fas fa-power-off"></i></div>
                            <div class="icon-option" data-icon="fas fa-lightbulb"><i class="fas fa-lightbulb"></i></div>
                            <div class="icon-option" data-icon="fas fa-motorcycle"><i class="fas fa-motorcycle"></i></div>
                            <div class="icon-option" data-icon="fas fa-car"><i class="fas fa-car"></i></div>
                            <div class="icon-option" data-icon="fas fa-robot"><i class="fas fa-robot"></i></div>
                            <div class="icon-option" data-icon="fas fa-cog"><i class="fas fa-cog"></i></div>
                            <div class="icon-option" data-icon="fas fa-fan"><i class="fas fa-fan"></i></div>
                            <div class="icon-option" data-icon="fas fa-music"><i class="fas fa-music"></i></div>
                            <div class="icon-option" data-icon="fas fa-bell"><i class="fas fa-bell"></i></div>
                        </div>
                        <input type="hidden" id="buttonIcon" value="fas fa-cog">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveBtn">Save Button</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';
            
            // App state
            let ws = null;
            let reconnectInterval = null;
            let isConnected = false;
            let messagesSent = 0;
            let messagesReceived = 0;
            let consolePaused = false;
            let consoleBuffer = [];
            let settings = {};
            
            // Joystick configuration
            let joystickConfig = {
                mode: 'analog', // 'analog' or 'digital'
                sensitivity: 5, // 1-10
                deadzone: 0.1, // 10% deadzone
                active: false,
                x: 0,
                y: 0,
                lastSentX: 0,
                lastSentY: 0,
                sendInterval: null,
                motorLeft: {
                    speed: 0,
                    direction: 'STOP'
                },
                motorRight: {
                    speed: 0,
                    direction: 'STOP'
                }
            };
            
            // Load settings from localStorage
            function loadSettings() {
                const savedSettings = localStorage.getItem('arduinoSettings');
                if (savedSettings) {
                    settings = JSON.parse(savedSettings);
                } else {
                    // Default settings
                    settings = {
                        autoReconnect: true,
                        reconnectDelay: 5,
                        showTimestamps: true,
                        buttonAnimation: true,
                        consoleFontSize: 14,
                        darkMode: false,
                        autoSaveButtons: true,
                        saveConsoleHistory: false,
                        maxConsoleLines: 100,
                        consoleLines: []
                    };
                }
                
                // Apply settings
                applySettings();
            }
            
            // Save settings to localStorage
            function saveSettings() {
                localStorage.setItem('arduinoSettings', JSON.stringify(settings));
            }
            
            // Apply settings to UI
            function applySettings() {
                // Update form controls
                document.getElementById('autoReconnect').checked = settings.autoReconnect;
                document.getElementById('reconnectDelay').value = settings.reconnectDelay;
                document.getElementById('reconnectDelayValue').textContent = settings.reconnectDelay;
                document.getElementById('showTimestamps').checked = settings.showTimestamps;
                document.getElementById('buttonAnimation').checked = settings.buttonAnimation;
                document.getElementById('consoleFontSize').value = settings.consoleFontSize;
                document.getElementById('consoleFontSizeValue').textContent = settings.consoleFontSize;
                document.getElementById('darkMode').checked = settings.darkMode;
                document.getElementById('autoSaveButtons').checked = settings.autoSaveButtons;
                document.getElementById('saveConsoleHistory').checked = settings.saveConsoleHistory;
                document.getElementById('maxConsoleLines').value = settings.maxConsoleLines;
                document.getElementById('maxConsoleLinesValue').textContent = settings.maxConsoleLines;
                
                // Apply dark mode
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                
                // Apply console font size
                document.getElementById('consoleOutput').style.fontSize = settings.consoleFontSize + 'px';
                
                // Restore console history if enabled
                if (settings.saveConsoleHistory && settings.consoleLines) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    settings.consoleLines.forEach(line => {
                        consoleOutput.innerHTML += line;
                    });
                }
            }
            
            // Buttons storage
            let buttons = [];
            
            // Load buttons from localStorage
            function loadButtons() {
                const savedButtons = localStorage.getItem('arduinoButtons');
                if (savedButtons) {
                    buttons = JSON.parse(savedButtons);
                } else {
                    // Default buttons
                    buttons = [
                        { id: 1, name: 'Forward', command: 'F', color: '#38a169', icon: 'fas fa-arrow-up' },
                        { id: 2, name: 'Stop', command: 'S', color: '#4a5568', icon: 'fas fa-stop' },
                        { id: 3, name: 'Backward', command: 'B', color: '#e53e3e', icon: 'fas fa-arrow-down' },
                        { id: 4, name: 'LED On', command: 'L1', color: '#d69e2e', icon: 'fas fa-lightbulb' },
                        { id: 5, name: 'LED Off', command: 'L0', color: '#805ad5', icon: 'fas fa-lightbulb' },
                        { id: 6, name: 'Servo 90¬∞', command: 'M90', color: '#319795', icon: 'fas fa-cog' },
                        { id: 7, name: 'Servo 0¬∞', command: 'M0', color: '#dd6b20', icon: 'fas fa-cog' }
                    ];
                }
            }
            
            // Save buttons to localStorage
            function saveButtons() {
                if (settings.autoSaveButtons) {
                    localStorage.setItem('arduinoButtons', JSON.stringify(buttons));
                }
            }
            
            // Arduino code examples
            const codeExamples = {
                joystick: `/*
 * H-BRIDGE MOTOR CONTROL WITH L298N
 * Controls two DC motors using L298N H-Bridge
 * Receives joystick commands: JX{x}Y{y}L{left}R{right}LD{d}RD{d}
 */

// Motor A (Left Motor) connections
const int ENA = 9;    // Enable A (PWM)
const int IN1 = 8;    // Input 1
const int IN2 = 7;    // Input 2

// Motor B (Right Motor) connections  
const int ENB = 6;    // Enable B (PWM)
const int IN3 = 5;    // Input 3
const int IN4 = 4;    // Input 4

// Joystick variables
float joyX = 0.0;
float joyY = 0.0;
int leftSpeed = 0;
int rightSpeed = 0;
char leftDir = 'S';  // 'F'=Forward, 'B'=Backward, 'S'=Stop
char rightDir = 'S';

void setup() {
  Serial.begin(9600);
  
  // Set all motor control pins as outputs
  pinMode(ENA, OUTPUT);
  pinMode(ENB, OUTPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  
  // Stop motors initially
  stopMotors();
  
  Serial.println("H-Bridge Motor Control Ready");
  Serial.println("Format: JX{x}Y{y}L{left}R{right}LD{d}RD{d}");
}

void loop() {
  if (Serial.available() > 0) {
    String command = Serial.readStringUntil('\\n');
    command.trim();
    
    // Check if it's a joystick command
    if (command.startsWith("J")) {
      parseJoystickCommand(command);
      updateMotors();
    }
  }
}

void parseJoystickCommand(String cmd) {
  // Format: JX0.75Y-0.25L100R75LDFRDB
  // X, Y: joystick position (-1.0 to 1.0)
  // L, R: motor speeds (0-100%)
  // LD, RD: motor directions (F=Forward, B=Backward, S=Stop)
  
  int xIndex = cmd.indexOf('X');
  int yIndex = cmd.indexOf('Y');
  int lIndex = cmd.indexOf('L', yIndex + 1);
  int rIndex = cmd.indexOf('R', lIndex + 1);
  int ldIndex = cmd.indexOf("LD", rIndex + 1);
  int rdIndex = cmd.indexOf("RD", ldIndex + 2);
  
  if (xIndex != -1 && yIndex != -1 && lIndex != -1 && rIndex != -1) {
    // Parse X and Y values
    String xStr = cmd.substring(xIndex + 1, yIndex);
    String yStr = cmd.substring(yIndex + 1, lIndex);
    
    joyX = xStr.toFloat();
    joyY = yStr.toFloat();
    
    // Parse motor speeds
    String leftStr = cmd.substring(lIndex + 1, rIndex);
    String rightStr = cmd.substring(rIndex + 1, ldIndex);
    
    leftSpeed = leftStr.toInt();
    rightSpeed = rightStr.toInt();
    
    // Parse motor directions
    if (ldIndex != -1) leftDir = cmd.charAt(ldIndex + 2);
    if (rdIndex != -1) rightDir = cmd.charAt(rdIndex + 2);
    
    // Clamp values
    joyX = constrain(joyX, -1.0, 1.0);
    joyY = constrain(joyY, -1.0, 1.0);
    leftSpeed = constrain(leftSpeed, 0, 100);
    rightSpeed = constrain(rightSpeed, 0, 100);
    
    // Send back confirmation
    Serial.print("X=");
    Serial.print(joyX, 2);
    Serial.print(" Y=");
    Serial.print(joyY, 2);
    Serial.print(" L=");
    Serial.print(leftSpeed);
    Serial.print(leftDir);
    Serial.print(" R=");
    Serial.print(rightSpeed);
    Serial.println(rightDir);
  }
}

void updateMotors() {
  // Control Left Motor
  controlMotor(leftDir, leftSpeed, ENA, IN1, IN2, 'L');
  
  // Control Right Motor
  controlMotor(rightDir, rightSpeed, ENB, IN3, IN4, 'R');
}

void controlMotor(char direction, int speed, int enablePin, int pin1, int pin2, char motorName) {
  // Convert percentage to PWM (0-255)
  int pwmValue = map(speed, 0, 100, 0, 255);
  
  switch(direction) {
    case 'F':  // Forward
      digitalWrite(pin1, HIGH);
      digitalWrite(pin2, LOW);
      analogWrite(enablePin, pwmValue);
      break;
      
    case 'B':  // Backward
      digitalWrite(pin1, LOW);
      digitalWrite(pin2, HIGH);
      analogWrite(enablePin, pwmValue);
      break;
      
    case 'S':  // Stop
    default:
      digitalWrite(pin1, LOW);
      digitalWrite(pin2, LOW);
      analogWrite(enablePin, 0);
      break;
  }
}

void stopMotors() {
  // Stop both motors
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
  analogWrite(ENA, 0);
  analogWrite(ENB, 0);
  
  Serial.println("Motors stopped");
}

// Alternative: Simple joystick parser for basic control
void parseSimpleJoystick(String cmd) {
  // Format: JX{x}Y{y}
  int xIndex = cmd.indexOf('X');
  int yIndex = cmd.indexOf('Y');
  
  if (xIndex != -1 && yIndex != -1) {
    String xStr = cmd.substring(xIndex + 1, yIndex);
    String yStr = cmd.substring(yIndex + 1);
    
    joyX = xStr.toFloat();
    joyY = yStr.toFloat();
    
    // Calculate motor speeds using differential drive
    float leftMotor = joyY + joyX;
    float rightMotor = joyY - joyX;
    
    // Constrain to -1.0 to 1.0
    leftMotor = constrain(leftMotor, -1.0, 1.0);
    rightMotor = constrain(rightMotor, -1.0, 1.0);
    
    // Convert to percentages and directions
    leftSpeed = abs(leftMotor) * 100;
    rightSpeed = abs(rightMotor) * 100;
    leftDir = leftMotor > 0 ? 'F' : (leftMotor < 0 ? 'B' : 'S');
    rightDir = rightMotor > 0 ? 'F' : (rightMotor < 0 ? 'B' : 'S');
    
    // Apply deadzone (stop if both values are very small)
    if (abs(joyX) < 0.1 && abs(joyY) < 0.1) {
      leftSpeed = 0;
      rightSpeed = 0;
      leftDir = 'S';
      rightDir = 'S';
    }
    
    Serial.print("Simple: L=");
    Serial.print(leftSpeed);
    Serial.print(leftDir);
    Serial.print(" R=");
    Serial.print(rightSpeed);
    Serial.println(rightDir);
  }
}`,
                basic: `/*
 * BASIC SERIAL CONTROL
 * This is a simple example that reads commands from Serial
 * and prints responses back.
 */

void setup() {
  Serial.begin(9600);           // Start serial communication
  pinMode(LED_BUILTIN, OUTPUT); // Built-in LED as output
  Serial.println("Ready!");     // Send ready message
}

void loop() {
  if (Serial.available() > 0) {
    char command = Serial.read(); // Read incoming command
    
    switch(command) {
      case 'F':  // Forward
        Serial.println("Moving forward");
        // Add your forward code here
        break;
        
      case 'B':  // Backward
        Serial.println("Moving backward");
        // Add your backward code here
        break;
        
      case 'S':  // Stop
        Serial.println("Stopping");
        // Add your stop code here
        break;
        
      case 'L':  // LED control
        char ledState = Serial.read();
        if (ledState == '1') {
          digitalWrite(LED_BUILTIN, HIGH);
          Serial.println("LED ON");
        } else if (ledState == '0') {
          digitalWrite(LED_BUILTIN, LOW);
          Serial.println("LED OFF");
        }
        break;
        
      default:
        Serial.print("Unknown command: ");
        Serial.println(command);
    }
  }
}`,

                motor: `/*
 * DC MOTOR CONTROL WITH L298N
 * Controls a DC motor using L298N motor driver
 */

// Motor pins
const int ENA = 9;   // Enable pin
const int IN1 = 8;   // Input 1
const int IN2 = 7;   // Input 2

void setup() {
  Serial.begin(9600);
  
  // Set motor pins as outputs
  pinMode(ENA, OUTPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  
  // Start with motor off
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  analogWrite(ENA, 0);
  
  Serial.println("Motor Control Ready");
}

void loop() {
  if (Serial.available() > 0) {
    String command = Serial.readStringUntil('\\n');
    command.trim();
    
    if (command == "F") {
      // Forward
      digitalWrite(IN1, HIGH);
      digitalWrite(IN2, LOW);
      analogWrite(ENA, 200); // 200/255 speed
      Serial.println("Motor: Forward");
      
    } else if (command == "B") {
      // Backward
      digitalWrite(IN1, LOW);
      digitalWrite(IN2, HIGH);
      analogWrite(ENA, 200);
      Serial.println("Motor: Backward");
      
    } else if (command == "S") {
      // Stop
      digitalWrite(IN1, LOW);
      digitalWrite(IN2, LOW);
      analogWrite(ENA, 0);
      Serial.println("Motor: Stop");
      
    } else if (command.startsWith("SP")) {
      // Speed control: SP150 = speed 150
      int speed = command.substring(2).toInt();
      speed = constrain(speed, 0, 255);
      analogWrite(ENA, speed);
      Serial.print("Speed: ");
      Serial.println(speed);
    }
  }
}`,

                servo: `/*
 * SERVO MOTOR CONTROL
 * Controls a servo motor using the Servo library
 */

#include <Servo.h>

Servo myServo;  // Create servo object
int servoPos = 90;  // Current position

void setup() {
  Serial.begin(9600);
  myServo.attach(9);  // Attach servo to pin 9
  myServo.write(servoPos);  // Start at center position
  Serial.println("Servo Ready (0-180 degrees)");
}

void loop() {
  if (Serial.available() > 0) {
    String command = Serial.readStringUntil('\\n');
    command.trim();
    
    if (command.startsWith("M")) {
      // Move to position: M90 = move to 90 degrees
      int angle = command.substring(1).toInt();
      angle = constrain(angle, 0, 180);
      
      myServo.write(angle);
      servoPos = angle;
      
      Serial.print("Servo: ");
      Serial.print(angle);
      Serial.println(" degrees");
      
    } else if (command == "LEFT") {
      // Move left (decrease angle)
      servoPos = constrain(servoPos - 10, 0, 180);
      myServo.write(servoPos);
      Serial.print("Servo left: ");
      Serial.println(servoPos);
      
    } else if (command == "RIGHT") {
      // Move right (increase angle)
      servoPos = constrain(servoPos + 10, 0, 180);
      myServo.write(servoPos);
      Serial.print("Servo right: ");
      Serial.println(servoPos);
      
    } else if (command == "CENTER") {
      // Center position
      servoPos = 90;
      myServo.write(servoPos);
      Serial.println("Servo centered");
    }
  }
}`,

                led: `/*
 * MULTI-LED CONTROL
 * Controls multiple LEDs with different commands
 */

// LED pins
const int LED_RED = 2;
const int LED_GREEN = 3;
const int LED_BLUE = 4;
const int LED_YELLOW = 5;

void setup() {
  Serial.begin(9600);
  
  // Set LED pins as outputs
  pinMode(LED_RED, OUTPUT);
  pinMode(LED_GREEN, OUTPUT);
  pinMode(LED_BLUE, OUTPUT);
  pinMode(LED_YELLOW, OUTPUT);
  
  // Turn all LEDs off initially
  digitalWrite(LED_RED, LOW);
  digitalWrite(LED_GREEN, LOW);
  digitalWrite(LED_BLUE, LOW);
  digitalWrite(LED_YELLOW, LOW);
  
  Serial.println("LED Control Ready");
  Serial.println("Commands: R1/R0, G1/G0, B1/B0, Y1/Y0, ALL1/ALL0");
}

void loop() {
  if (Serial.available() > 0) {
    String command = Serial.readStringUntil('\\n');
    command.trim();
    
    if (command == "R1") {
      digitalWrite(LED_RED, HIGH);
      Serial.println("Red LED ON");
    } else if (command == "R0") {
      digitalWrite(LED_RED, LOW);
      Serial.println("Red LED OFF");
      
    } else if (command == "G1") {
      digitalWrite(LED_GREEN, HIGH);
      Serial.println("Green LED ON");
    } else if (command == "G0") {
      digitalWrite(LED_GREEN, LOW);
      Serial.println("Green LED OFF");
      
    } else if (command == "B1") {
      digitalWrite(LED_BLUE, HIGH);
      Serial.println("Blue LED ON");
    } else if (command == "B0") {
      digitalWrite(LED_BLUE, LOW);
      Serial.println("Blue LED OFF");
      
    } else if (command == "Y1") {
      digitalWrite(LED_YELLOW, HIGH);
      Serial.println("Yellow LED ON");
    } else if (command == "Y0") {
      digitalWrite(LED_YELLOW, LOW);
      Serial.println("Yellow LED OFF");
      
    } else if (command == "ALL1") {
      digitalWrite(LED_RED, HIGH);
      digitalWrite(LED_GREEN, HIGH);
      digitalWrite(LED_BLUE, HIGH);
      digitalWrite(LED_YELLOW, HIGH);
      Serial.println("All LEDs ON");
    } else if (command == "ALL0") {
      digitalWrite(LED_RED, LOW);
      digitalWrite(LED_GREEN, LOW);
      digitalWrite(LED_BLUE, LOW);
      digitalWrite(LED_YELLOW, LOW);
      Serial.println("All LEDs OFF");
      
    } else if (command == "BLINK") {
      // Blink all LEDs 3 times
      for (int i = 0; i < 3; i++) {
        digitalWrite(LED_RED, HIGH);
        digitalWrite(LED_GREEN, HIGH);
        digitalWrite(LED_BLUE, HIGH);
        digitalWrite(LED_YELLOW, HIGH);
        delay(200);
        digitalWrite(LED_RED, LOW);
        digitalWrite(LED_GREEN, LOW);
        digitalWrite(LED_BLUE, LOW);
        digitalWrite(LED_YELLOW, LOW);
        delay(200);
      }
      Serial.println("Blink complete");
    }
  }
}`,

                sensor: `/*
 * SENSOR READING EXAMPLE
 * Reads sensors and sends data back to computer
 */

const int TEMP_SENSOR = A0;   // Temperature sensor pin
const int LIGHT_SENSOR = A1;  // Light sensor pin
const int TRIG_PIN = 6;       // Ultrasonic trigger
const int ECHO_PIN = 7;       // Ultrasonic echo

void setup() {
  Serial.begin(9600);
  
  // Setup ultrasonic sensor
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  
  Serial.println("Sensor System Ready");
  Serial.println("Commands: TEMP, LIGHT, DISTANCE, ALL");
}

void loop() {
  if (Serial.available() > 0) {
    String command = Serial.readStringUntil('\\n');
    command.trim();
    
    if (command == "TEMP") {
      // Read temperature
      int rawTemp = analogRead(TEMP_SENSOR);
      float voltage = rawTemp * (5.0 / 1023.0);
      float tempC = (voltage - 0.5) * 100;
      Serial.print("Temperature: ");
      Serial.print(tempC);
      Serial.println(" ¬∞C");
      
    } else if (command == "LIGHT") {
      // Read light level
      int lightLevel = analogRead(LIGHT_SENSOR);
      Serial.print("Light level: ");
      Serial.println(lightLevel);
      
    } else if (command == "DISTANCE") {
      // Measure distance
      digitalWrite(TRIG_PIN, LOW);
      delayMicroseconds(2);
      digitalWrite(TRIG_PIN, HIGH);
      delayMicroseconds(10);
      digitalWrite(TRIG_PIN, LOW);
      
      long duration = pulseIn(ECHO_PIN, HIGH);
      float distance = duration * 0.034 / 2;
      
      Serial.print("Distance: ");
      Serial.print(distance);
      Serial.println(" cm");
      
    } else if (command == "ALL") {
      // Read all sensors
      int rawTemp = analogRead(TEMP_SENSOR);
      float voltage = rawTemp * (5.0 / 1023.0);
      float tempC = (voltage - 0.5) * 100;
      
      int lightLevel = analogRead(LIGHT_SENSOR);
      
      digitalWrite(TRIG_PIN, LOW);
      delayMicroseconds(2);
      digitalWrite(TRIG_PIN, HIGH);
      delayMicroseconds(10);
      digitalWrite(TRIG_PIN, LOW);
      long duration = pulseIn(ECHO_PIN, HIGH);
      float distance = duration * 0.034 / 2;
      
      Serial.print("Temp: ");
      Serial.print(tempC);
      Serial.print("¬∞C, Light: ");
      Serial.print(lightLevel);
      Serial.print(", Dist: ");
      Serial.print(distance);
      Serial.println("cm");
    }
  }
}`
            };
            
            // DOM elements
            const elements = {
                buttonsGrid: document.getElementById('buttonsGrid'),
                configModal: document.getElementById('configModal'),
                buttonForm: document.getElementById('buttonForm'),
                buttonId: document.getElementById('buttonId'),
                buttonName: document.getElementById('buttonName'),
                buttonCommand: document.getElementById('buttonCommand'),
                buttonColor: document.getElementById('buttonColor'),
                buttonIcon: document.getElementById('buttonIcon'),
                settingsBtn: document.getElementById('settingsBtn'),
                helpBtn: document.getElementById('helpBtn'),
                addButton: document.getElementById('addButton'),
                closeModal: document.getElementById('closeModal'),
                cancelBtn: document.getElementById('cancelBtn'),
                clearConsole: document.getElementById('clearConsole'),
                pauseConsole: document.getElementById('pauseConsole'),
                buttonCount: document.getElementById('buttonCount'),
                messagesSent: document.getElementById('messagesSent'),
                messagesReceived: document.getElementById('messagesReceived'),
                codeSelect: document.getElementById('codeSelect'),
                codeDisplay: document.getElementById('codeDisplay'),
                joystickArea: document.getElementById('joystickArea'),
                joystick: document.getElementById('joystick'),
                joystickMode: document.getElementById('joystickMode'),
                joystickCenter: document.getElementById('joystickCenter'),
                joystickX: document.getElementById('joystickX'),
                joystickY: document.getElementById('joystickY'),
                joystickAngle: document.getElementById('joystickAngle')
            };
            
            // Initialize the app
            function init() {
                loadSettings();
                loadButtons();
                renderButtons();
                updateStats();
                setupEventListeners();
                connectWebSocket();
                setupCodeSyntaxHighlighting();
                setupJoystick();
                elements.codeSelect.value = 'joystick';
                updateCodeDisplay('joystick');
            }
            
            // Setup joystick functionality
function setupJoystick() {
    const joystickArea = elements.joystickArea;
    const joystick = elements.joystick;
    
    let isDragging = false;
    let areaRect, centerX, centerY, maxDistance;

    // Update dimensions of the joystick area
    function updateDimensions() {
        areaRect = joystickArea.getBoundingClientRect();
        centerX = areaRect.width / 2;
        centerY = areaRect.height / 2;
        maxDistance = Math.max(Math.min(centerX, centerY) - 40, 50);
        
        // Position joystick at center
        joystick.style.left = (centerX - 40) + 'px';
        joystick.style.top = (centerY - 40) + 'px';
    }
    
    // Calculate motor values from joystick position
    function calculateMotorValues(x, y) {
        // This implements differential drive algorithm
        // For H-bridge motor control
        
        let leftMotor, rightMotor;
        
        if (joystickConfig.mode === 'digital') {
            // Digital mode: 8-direction control
            const distance = Math.sqrt(x * x + y * y);
            if (distance > 0.3) {
                const angle = Math.atan2(y, x);
                const snappedAngle = Math.round(angle / (Math.PI / 4)) * (Math.PI / 4);
                x = Math.cos(snappedAngle);
                y = Math.sin(snappedAngle);
                
                // Clean values for digital mode
                if (Math.abs(x) < 0.1) x = 0;
                if (Math.abs(y) < 0.1) y = 0;
                if (x > 0.7) x = 1;
                if (x < -0.7) x = -1;
                if (y > 0.7) y = 1;
                if (y < -0.7) y = -1;
            } else {
                x = 0;
                y = 0;
            }
        }
        
        // Apply deadzone
        const distance = Math.sqrt(x * x + y * y);
        if (distance < joystickConfig.deadzone) {
            joystickConfig.motorLeft.speed = 0;
            joystickConfig.motorRight.speed = 0;
            joystickConfig.motorLeft.direction = 'STOP';
            joystickConfig.motorRight.direction = 'STOP';
            return;
        }
        
        // Apply sensitivity
        const sensitivityFactor = joystickConfig.sensitivity / 5; // 5 is default
        x = x * sensitivityFactor;
        y = y * sensitivityFactor;
        
        // Clamp values to -1 to 1
        x = Math.max(-1, Math.min(1, x));
        y = Math.max(-1, Math.min(1, y));
        
        // Differential drive calculation for H-bridge
        // leftMotor = y + x
        // rightMotor = y - x
        leftMotor = y + x;
        rightMotor = y - x;
        
        // Clamp motor values
        leftMotor = Math.max(-1, Math.min(1, leftMotor));
        rightMotor = Math.max(-1, Math.min(1, rightMotor));
        
        // Store motor values
        joystickConfig.motorLeft.speed = Math.abs(leftMotor) * 100;
        joystickConfig.motorRight.speed = Math.abs(rightMotor) * 100;
        
        joystickConfig.motorLeft.direction = leftMotor > 0 ? 'FORWARD' : 
                                           leftMotor < 0 ? 'BACKWARD' : 'STOP';
        joystickConfig.motorRight.direction = rightMotor > 0 ? 'FORWARD' : 
                                            rightMotor < 0 ? 'BACKWARD' : 'STOP';
    }
    
    // Update motor display
    function updateMotorDisplay() {
        const leftMotor = document.getElementById('leftMotorSpeed');
        const rightMotor = document.getElementById('rightMotorSpeed');
        const leftDir = document.getElementById('leftMotorDir');
        const rightDir = document.getElementById('rightMotorDir');
        
        if (leftMotor && rightMotor && leftDir && rightDir) {
            leftMotor.textContent = Math.round(joystickConfig.motorLeft.speed) + '%';
            rightMotor.textContent = Math.round(joystickConfig.motorRight.speed) + '%';
            
            leftDir.textContent = joystickConfig.motorLeft.direction;
            rightDir.textContent = joystickConfig.motorRight.direction;
            
            leftDir.className = 'motor-direction ' + joystickConfig.motorLeft.direction.toLowerCase();
            rightDir.className = 'motor-direction ' + joystickConfig.motorRight.direction.toLowerCase();
        }
    }
    
    // Start joystick sending interval
    function startJoystickSending() {
        if (joystickConfig.sendInterval) return;
        
        joystickConfig.sendInterval = setInterval(() => {
            if (joystickConfig.active && isConnected) {
                const x = joystickConfig.x;
                const y = joystickConfig.y;
                
                // Calculate motor values
                calculateMotorValues(x, y);
                
                // Only send if values changed significantly
                if (Math.abs(x - joystickConfig.lastSentX) > 0.01 || 
                    Math.abs(y - joystickConfig.lastSentY) > 0.01 ||
                    joystickConfig.motorLeft.speed === 0 && joystickConfig.lastSentX !== 0) {
                    
                    sendJoystickCommand(x, y);
                    joystickConfig.lastSentX = x;
                    joystickConfig.lastSentY = y;
                    
                    // Update displays
                    updateMotorDisplay();
                    if (joystickConfig.mode === 'digital') {
                        updateJoystickDisplay(x, y);
                    }
                }
            }
        }, 100); // Send every 100ms
    }
    
    // Stop joystick sending interval
    function stopJoystickSending() {
        if (joystickConfig.sendInterval) {
            clearInterval(joystickConfig.sendInterval);
            joystickConfig.sendInterval = null;
        }
    }
    
    // Update joystick display
    function updateJoystickDisplay(x, y) {
        elements.joystickX.textContent = x.toFixed(2);
        elements.joystickY.textContent = y.toFixed(2);
        
        // Calculate angle
        const angle = Math.atan2(y, x) * (180 / Math.PI);
        elements.joystickAngle.textContent = Math.round(angle) + '¬∞';
        
        // Update joystick position
        const posX = centerX + (x * maxDistance);
        const posY = centerY - (y * maxDistance); // Invert Y axis
        
        joystick.style.left = (posX - 40) + 'px';
        joystick.style.top = (posY - 40) + 'px';
        
        // Update joystick color based on position intensity
        const intensity = Math.sqrt(x * x + y * y);
        const hue = 210; // Blue color
        const saturation = 70 + (intensity * 30);
        const lightness = 50 - (intensity * 20);
        joystick.style.background = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }
    
    // Send joystick command to Arduino
    function sendJoystickCommand(x, y) {
        if (!isConnected) return;
        
        // Format: JX{value}Y{value}L{left_speed}R{right_speed}LD{left_dir}RD{right_dir}
        const command = `JX${x.toFixed(2)}Y${y.toFixed(2)}L${Math.round(joystickConfig.motorLeft.speed)}R${Math.round(joystickConfig.motorRight.speed)}LD${joystickConfig.motorLeft.direction.charAt(0)}RD${joystickConfig.motorRight.direction.charAt(0)}`;
        
        sendCommand(command);
        addToConsole(`Joystick: L=${Math.round(joystickConfig.motorLeft.speed)}% ${joystickConfig.motorLeft.direction}, R=${Math.round(joystickConfig.motorRight.speed)}% ${joystickConfig.motorRight.direction}`, 'info');
    }
    
    // Center joystick
    function centerJoystick() {
        joystickConfig.x = 0;
        joystickConfig.y = 0;
        joystickConfig.motorLeft.speed = 0;
        joystickConfig.motorRight.speed = 0;
        joystickConfig.motorLeft.direction = 'STOP';
        joystickConfig.motorRight.direction = 'STOP';
        
        updateJoystickDisplay(0, 0);
        updateMotorDisplay();
        sendJoystickCommand(0, 0);
    }
    
    // Handle mouse/touch events
    function startDrag(e) {
        e.preventDefault();
        e.stopPropagation();
        
        updateDimensions();
        isDragging = true;
        joystickConfig.active = true;
        joystick.style.transform = 'scale(1.1)';
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
        startJoystickSending();
        
        // Initial drag to current position
        drag(e);
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        if (e.cancelable) {
            e.preventDefault();
        }
        
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        if (clientX === undefined || clientY === undefined) return;
        
        // Calculate position relative to joystick area center
        const x = clientX - areaRect.left - centerX;
        const y = centerY - (clientY - areaRect.top); // Invert Y axis
        
        // Calculate distance from center
        const distance = Math.sqrt(x * x + y * y);
        
        // Limit to max distance
        const limitedX = distance > maxDistance ? (x / distance) * maxDistance : x;
        const limitedY = distance > maxDistance ? (y / distance) * maxDistance : y;
        
        // Normalize to -1 to 1 range
        joystickConfig.x = limitedX / maxDistance;
        joystickConfig.y = limitedY / maxDistance;
        
        // Calculate motor values for display
        calculateMotorValues(joystickConfig.x, joystickConfig.y);
        
        updateJoystickDisplay(joystickConfig.x, joystickConfig.y);
        updateMotorDisplay();
    }
    
    function stopDrag() {
        if (!isDragging) return;
        
        isDragging = false;
        joystickConfig.active = false;
        joystick.style.transform = '';
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
        
        // Return to center with animation
        const startX = joystickConfig.x;
        const startY = joystickConfig.y;
        const duration = 300; // ms
        const startTime = Date.now();
        
        function animateReturn() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Ease out function
            const easeOut = 1 - Math.pow(1 - progress, 3);
            
            joystickConfig.x = startX * (1 - easeOut);
            joystickConfig.y = startY * (1 - easeOut);
            
            // Calculate motor values during animation
            calculateMotorValues(joystickConfig.x, joystickConfig.y);
            
            updateJoystickDisplay(joystickConfig.x, joystickConfig.y);
            updateMotorDisplay();
            
            if (progress < 1) {
                requestAnimationFrame(animateReturn);
            } else {
                centerJoystick();
                stopJoystickSending();
            }
        }
        
        requestAnimationFrame(animateReturn);
    }
    
    // Event listeners for joystick - USING PASSIVE EVENT LISTENERS FOR TOUCH
    joystick.addEventListener('mousedown', startDrag);
    joystick.addEventListener('touchstart', startDrag, { passive: false });
    joystickArea.addEventListener('mousedown', startDrag);
    joystickArea.addEventListener('touchstart', startDrag, { passive: false });
    
    // Joystick mode button
    elements.joystickMode.addEventListener('click', () => {
        if (joystickConfig.mode === 'analog') {
            joystickConfig.mode = 'digital';
            elements.joystickMode.innerHTML = '<i class="fas fa-gamepad"></i> <span class="btn-text">Digital Mode</span>';
            elements.joystickMode.classList.add('active');
            addToConsole('Joystick mode: Digital (8-direction)', 'info');
        } else {
            joystickConfig.mode = 'analog';
            elements.joystickMode.innerHTML = '<i class="fas fa-sliders-h"></i> <span class="btn-text">Analog Mode</span>';
            elements.joystickMode.classList.remove('active');
            addToConsole('Joystick mode: Analog (continuous)', 'info');
        }
    });
    
    // Center button
    elements.joystickCenter.addEventListener('click', centerJoystick);
    
    // Sensitivity slider
    document.getElementById('sensitivity').addEventListener('input', (e) => {
        joystickConfig.sensitivity = parseInt(e.target.value);
        document.getElementById('sensitivityValue').textContent = joystickConfig.sensitivity;
    });
    
    // Deadzone slider
    document.getElementById('deadzone').addEventListener('input', (e) => {
        const deadzoneValue = parseInt(e.target.value);
        joystickConfig.deadzone = deadzoneValue / 100;
        document.getElementById('deadzoneValue').textContent = deadzoneValue + '%';
    });
    
    // Initial setup
    updateDimensions();
    centerJoystick();
    
    // Handle window resize
    window.addEventListener('resize', updateDimensions);
    
    // Handle tab switching to refresh joystick
    document.querySelector('.tab[data-tab="joystick"]').addEventListener('click', () => {
        setTimeout(updateDimensions, 50);
    });
}
            
            // Setup code syntax highlighting
            function setupCodeSyntaxHighlighting() {
                // Syntax highlighting function
                window.highlightCode = function(code) {
                    return code
                        };
            }
            
            // Update code display
            function updateCodeDisplay(example) {
                const code = codeExamples[example] || codeExamples.joystick;
                elements.codeDisplay.innerHTML = window.highlightCode(code);
            }
            
            // Render all buttons
            function renderButtons() {
                elements.buttonsGrid.innerHTML = '';
                
                buttons.forEach(button => {
                    const buttonEl = createButtonElement(button);
                    elements.buttonsGrid.appendChild(buttonEl);
                });
                
                elements.buttonCount.textContent = `${buttons.length} button${buttons.length !== 1 ? 's' : ''}`;
            }
            
            // Create button HTML element
            function createButtonElement(button) {
                const div = document.createElement('div');
                div.className = 'control-btn';
                div.style.background = button.color;
                
                // Apply animation based on settings
                if (!settings.buttonAnimation) {
                    div.style.transition = 'none';
                }
                
                div.innerHTML = `
                    <button class="btn-remove" data-id="${button.id}" title="Remove button">&times;</button>
                    <i class="${button.icon}"></i>
                    <span class="btn-label">${button.name}</span>
                    <span class="btn-command">${button.command}</span>
                `;
                
                div.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('btn-remove')) {
                        sendCommand(button.command);
                        
                        // Add animation effect if enabled
                        if (settings.buttonAnimation) {
                            div.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                div.style.transform = '';
                            }, 100);
                        }
                    }
                });
                
                return div;
            }
            
            // Setup event listeners
            function setupEventListeners() {
                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.dataset.tab;
                        
                        // Update active tab
                        document.querySelectorAll('.tab').forEach(t => 
                            t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Show corresponding content
                        document.querySelectorAll('.tab-content').forEach(content => 
                            content.classList.remove('active'));
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                    });
                });
                
                // Add new button
                elements.addButton.addEventListener('click', () => openModal());
                
                // Settings button
                elements.settingsBtn.addEventListener('click', () => {
                    document.querySelector('.tab[data-tab="settings"]').click();
                });
                
                // Help button
                elements.helpBtn.addEventListener('click', () => {
                    alert('Help Guide:\n\n' +
                          '1. Add buttons using "Add Button"\n' +
                          '2. Click buttons to send commands\n' +
                          '3. Use virtual joystick for analog control\n' +
                          '4. View Arduino code examples\n' +
                          '5. Configure settings as needed\n' +
                          '6. Use keyboard shortcuts:\n' +
                          '   - Ctrl+Shift+N: Add button\n' +
                          '   - Escape: Close modal\n' +
                          '   - Arrow keys: Quick commands');
                });
                
                // Modal controls
                elements.closeModal.addEventListener('click', closeModal);
                elements.cancelBtn.addEventListener('click', closeModal);
                
                // Color picker
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.color-option').forEach(opt => 
                            opt.classList.remove('selected'));
                        option.classList.add('selected');
                        elements.buttonColor.value = option.dataset.color;
                    });
                });
                
                // Icon picker
                document.querySelectorAll('.icon-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.icon-option').forEach(opt => 
                            opt.classList.remove('selected'));
                        option.classList.add('selected');
                        elements.buttonIcon.value = option.dataset.icon;
                    });
                });
                
                // Form submission
                elements.buttonForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveButton();
                });
                
                // Console controls
                elements.clearConsole.addEventListener('click', () => {
                    document.getElementById('consoleOutput').innerHTML = '';
                    settings.consoleLines = [];
                    saveSettings();
                    addToConsole('Console cleared', 'info');
                });
                
                elements.pauseConsole.addEventListener('click', () => {
                    consolePaused = !consolePaused;
                    elements.pauseConsole.innerHTML = consolePaused ? 
                        '<i class="fas fa-play"></i> Resume' : 
                        '<i class="fas fa-pause"></i> Pause';
                    
                    if (!consolePaused && consoleBuffer.length > 0) {
                        consoleBuffer.forEach(msg => addToConsole(msg.text, msg.type));
                        consoleBuffer = [];
                    }
                });
                
                // Code selection
                elements.codeSelect.addEventListener('change', (e) => {
                    updateCodeDisplay(e.target.value);
                });
                
                // Settings controls
                document.getElementById('autoReconnect').addEventListener('change', (e) => {
                    settings.autoReconnect = e.target.checked;
                    saveSettings();
                });
                
                document.getElementById('reconnectDelay').addEventListener('input', (e) => {
                    settings.reconnectDelay = parseInt(e.target.value);
                    document.getElementById('reconnectDelayValue').textContent = settings.reconnectDelay;
                    saveSettings();
                });
                
                document.getElementById('showTimestamps').addEventListener('change', (e) => {
                    settings.showTimestamps = e.target.checked;
                    saveSettings();
                });
                
                document.getElementById('darkMode').addEventListener('change', (e) => {
                    settings.darkMode = e.target.checked;
                    applySettings();
                    saveSettings();
                });
                
                document.getElementById('buttonAnimation').addEventListener('change', (e) => {
                    settings.buttonAnimation = e.target.checked;
                    renderButtons(); // Re-render to apply/remove animations
                    saveSettings();
                });
                
                document.getElementById('consoleFontSize').addEventListener('input', (e) => {
                    settings.consoleFontSize = parseInt(e.target.value);
                    document.getElementById('consoleFontSizeValue').textContent = settings.consoleFontSize;
                    document.getElementById('consoleOutput').style.fontSize = settings.consoleFontSize + 'px';
                    saveSettings();
                });
                
                document.getElementById('autoSaveButtons').addEventListener('change', (e) => {
                    settings.autoSaveButtons = e.target.checked;
                    if (settings.autoSaveButtons) {
                        saveButtons(); // Save immediately if turned on
                    }
                    saveSettings();
                });
                
                document.getElementById('saveConsoleHistory').addEventListener('change', (e) => {
                    settings.saveConsoleHistory = e.target.checked;
                    if (!settings.saveConsoleHistory) {
                        settings.consoleLines = [];
                    }
                    saveSettings();
                });
                
                document.getElementById('maxConsoleLines').addEventListener('input', (e) => {
                    settings.maxConsoleLines = parseInt(e.target.value);
                    document.getElementById('maxConsoleLinesValue').textContent = settings.maxConsoleLines;
                    saveSettings();
                });
                
                // Tools
                document.getElementById('exportButtons').addEventListener('click', exportButtons);
                document.getElementById('importButtons').addEventListener('click', () => {
                    document.getElementById('importFile').click();
                });
                document.getElementById('importFile').addEventListener('change', importButtons);
                document.getElementById('resetSettings').addEventListener('click', resetSettings);
                
                // Remove button event delegation
                elements.buttonsGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-remove')) {
                        const id = parseInt(e.target.dataset.id);
                        if (confirm('Are you sure you want to remove this button?')) {
                            removeButton(id);
                        }
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Ctrl+Shift+N to add new button
                    if (e.ctrlKey && e.shiftKey && e.key === 'N') {
                        e.preventDefault();
                        openModal();
                    }
                    
                    // Escape to close modal
                    if (e.key === 'Escape' && elements.configModal.style.display === 'flex') {
                        closeModal();
                    }
                    
                    // Quick command shortcuts
                    if (!e.ctrlKey && !e.shiftKey && !e.altKey) {
                        switch(e.key) {
                            case 'ArrowUp':
                            case 'w':
                            case 'W':
                                e.preventDefault();
                                sendCommand('F');
                                break;
                            case 'ArrowDown':
                            case 's':
                            case 'S':
                                e.preventDefault();
                                sendCommand('B');
                                break;
                            case ' ':
                                e.preventDefault();
                                sendCommand('S');
                                break;
                        }
                    }
                });
                
                // Close modal when clicking outside
                elements.configModal.addEventListener('click', (e) => {
                    if (e.target === elements.configModal) {
                        closeModal();
                    }
                });
            }
            
            // Open modal for editing/creating button
            function openModal(buttonId = null) {
                // Reset form
                elements.buttonForm.reset();
                elements.buttonId.value = '';
                elements.buttonColor.value = '#4a5568';
                elements.buttonIcon.value = 'fas fa-cog';
                
                // Reset selections
                document.querySelectorAll('.color-option, .icon-option').forEach(el => 
                    el.classList.remove('selected'));
                
                // Set default selections
                document.querySelector('.color-option[data-color="#4a5568"]').classList.add('selected');
                document.querySelector('.icon-option[data-icon="fas fa-cog"]').classList.add('selected');
                
                // If editing existing button
                if (buttonId) {
                    const button = buttons.find(b => b.id === buttonId);
                    if (button) {
                        elements.buttonId.value = button.id;
                        elements.buttonName.value = button.name;
                        elements.buttonCommand.value = button.command;
                        elements.buttonColor.value = button.color;
                        elements.buttonIcon.value = button.icon;
                        
                        // Select color and icon
                        document.querySelector(`.color-option[data-color="${button.color}"]`)?.classList.add('selected');
                        document.querySelector(`.icon-option[data-icon="${button.icon}"]`)?.classList.add('selected');
                    }
                }
                
                elements.configModal.style.display = 'flex';
            }
            
            // Close modal
            function closeModal() {
                elements.configModal.style.display = 'none';
            }
            
            // Save button to storage
            function saveButton() {
                const buttonData = {
                    id: elements.buttonId.value ? parseInt(elements.buttonId.value) : Date.now(),
                    name: elements.buttonName.value,
                    command: elements.buttonCommand.value,
                    color: elements.buttonColor.value,
                    icon: elements.buttonIcon.value
                };
                
                // Update or add
                const index = buttons.findIndex(b => b.id === buttonData.id);
                if (index > -1) {
                    buttons[index] = buttonData;
                } else {
                    buttons.push(buttonData);
                }
                
                // Save to localStorage
                saveButtons();
                
                // Update UI
                renderButtons();
                closeModal();
                addToConsole(`Button "${buttonData.name}" saved`, 'success');
            }
            
            // Remove button
            function removeButton(id) {
                buttons = buttons.filter(b => b.id !== id);
                saveButtons();
                renderButtons();
                addToConsole('Button removed', 'warning');
            }
            
            // Export buttons configuration
            function exportButtons() {
                const dataStr = JSON.stringify(buttons, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'arduino-buttons.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                addToConsole('Buttons configuration exported', 'success');
            }
            
            // Import buttons configuration
            function importButtons(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedButtons = JSON.parse(e.target.result);
                        buttons = importedButtons;
                        saveButtons();
                        renderButtons();
                        addToConsole('Buttons configuration imported', 'success');
                    } catch (error) {
                        addToConsole('Error importing configuration: Invalid JSON', 'error');
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                event.target.value = '';
            }
            
            // Reset settings
            function resetSettings() {
                if (confirm('Are you sure you want to reset all settings to defaults?')) {
                    localStorage.removeItem('arduinoSettings');
                    localStorage.removeItem('arduinoButtons');
                    location.reload();
                }
            }
            
            // Update statistics
            function updateStats() {
                elements.messagesSent.textContent = messagesSent;
                elements.messagesReceived.textContent = messagesReceived;
            }
            
// WebSocket connection
function connectWebSocket() {
    if (ws && ws.readyState !== WebSocket.CLOSED) {
        ws.close();
    }
    
    // Use relative URL for local development
    // This will connect to the same host as the page is served from
    let wsUrl;
    
    if (window.location.protocol === 'https:') {
        wsUrl = `wss://${window.location.host}`;
    } else {
        wsUrl = `ws://${window.location.host}`;
    }
    
    // Alternative: Use specific port if you know your server runs on port 3000
    // wsUrl = window.location.protocol === 'https:' ? 
    //     `wss://${window.location.hostname}:3000` : 
    //     `ws://${window.location.hostname}:3000`;
    
    addToConsole(`Connecting to WebSocket: ${wsUrl}`, 'info');
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
        addToConsole('Connected to server', 'success');
        updateWebSocketStatus(true);
        isConnected = true;
    };
    
    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            messagesReceived++;
            updateStats();
            
            switch(data.type) {
                case 'status':
                    updateBluetoothStatus(data.bluetoothConnected);
                    if (data.error) {
                        addToConsole(`Error: ${data.error}`, 'error');
                    }
                    break;
                    
                case 'ack':
                    addToConsole(`Command "${data.command}" ${data.success ? 'sent successfully' : 'failed to send'}`);
                    break;
                    
                case 'data':
                    addToConsole(`Arduino: ${data.message}`);
                    break;
            }
        } catch (error) {
            console.error('Error parsing WebSocket message:', error);
        }
    };
    
    ws.onclose = () => {
        addToConsole('Disconnected from server', 'warning');
        updateWebSocketStatus(false);
        isConnected = false;
        updateBluetoothStatus(false);
        
        if (settings.autoReconnect && !reconnectInterval) {
            reconnectInterval = setInterval(() => {
                addToConsole('Reconnecting...', 'info');
                connectWebSocket();
            }, settings.reconnectDelay * 1000);
        }
    };
    
    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        addToConsole('WebSocket connection failed. Make sure the Node.js server is running.', 'error');
    };
}
            
            function sendCommand(command) {
                if (!isConnected || !ws || ws.readyState !== WebSocket.OPEN) {
                    addToConsole('Not connected to server', 'error');
                    return;
                }
                
                try {
                    ws.send(JSON.stringify({ command: command }));
                    messagesSent++;
                    updateStats();
                    addToConsole(`Sending: ${command}`, 'info');
                } catch (error) {
                    addToConsole('Failed to send command', 'error');
                }
            }
            
            function updateBluetoothStatus(connected) {
                const statusDot = document.getElementById('bluetoothStatus');
                const statusText = document.getElementById('bluetoothText');
                const connectionDetails = document.getElementById('connectionDetails');
                
                if (connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Bluetooth: Connected';
                    connectionDetails.textContent = '‚úì Connected to Arduino via Bluetooth\nReady to send commands';
                } else {
                    statusDot.className = 'status-dot';
                    statusText.textContent = 'Bluetooth: Disconnected';
                    connectionDetails.textContent = '‚úó Disconnected from Arduino\nCheck Bluetooth connection and power';
                }
            }
            
            function updateWebSocketStatus(connected) {
                const statusDot = document.getElementById('websocketStatus');
                const statusText = document.getElementById('websocketText');
                
                if (connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'WebSocket: Connected';
                    
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }
                } else {
                    statusDot.className = 'status-dot';
                    statusText.textContent = 'WebSocket: Disconnected';
                }
            }
            
            function addToConsole(message, type = 'info') {
                const consoleOutput = document.getElementById('consoleOutput');
                
                // Handle pause state
                if (consolePaused) {
                    consoleBuffer.push({ text: message, type: type });
                    return;
                }
                
                const line = document.createElement('div');
                line.className = 'console-line';
                
                const timestamp = settings.showTimestamps ? 
                    `[${new Date().toLocaleTimeString()}] ` : '';
                let icon = '‚ÑπÔ∏è';
                
                switch(type) {
                    case 'error':
                        icon = '‚ùå';
                        line.style.color = '#fc8181';
                        break;
                    case 'warning':
                        icon = '‚ö†Ô∏è';
                        line.style.color = '#f6ad55';
                        break;
                    case 'success':
                        icon = '‚úÖ';
                        line.style.color = '#68d391';
                        break;
                    case 'info':
                        line.style.color = '#a0aec0';
                        break;
                }
                
                line.textContent = `${timestamp}${icon} ${message}`;
                consoleOutput.appendChild(line);
                
                // Save to history if enabled
                if (settings.saveConsoleHistory) {
                    settings.consoleLines.push(line.outerHTML);
                    if (settings.consoleLines.length > settings.maxConsoleLines) {
                        settings.consoleLines.shift();
                    }
                    saveSettings();
                }
                
                // Auto-scroll
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
                
                // Limit number of lines
                const lines = consoleOutput.getElementsByClassName('console-line');
                if (lines.length > settings.maxConsoleLines) {
                    consoleOutput.removeChild(lines[0]);
                }
            }
            
            // Initialize when page loads
            window.addEventListener('load', init);
            
            // Cleanup
            window.addEventListener('beforeunload', () => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                }
                if (joystickConfig.sendInterval) {
                    clearInterval(joystickConfig.sendInterval);
                }
            });
            
            // Export functions for debugging
            window.app = {
                sendCommand,
                addToConsole,
                buttons,
                settings,
                saveButtons,
                resetSettings,
                exportButtons,
                importButtons
            };
        })();
    </script>
</body>
</html>